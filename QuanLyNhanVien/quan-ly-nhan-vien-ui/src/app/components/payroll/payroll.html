<div class="payroll-container">
    <div class="page-header">
        <div class="header-content">
            <div class="title-section">
                <h2>{{ isAdmin ? 'Quản lý Lương & Thưởng' : 'Phiếu lương cá nhân' }}</h2>
                <span class="subtitle">Theo dõi và quản lý thu nhập hàng tháng</span>
            </div>
            
            <div class="control-panel" *ngIf="isAdmin">
                <div class="filter-group">
                    <mat-form-field appearance="outline" class="filter-field">
                        <mat-label>Tháng</mat-label>
                        <mat-select [(ngModel)]="selectedMonth" (selectionChange)="loadMonthlyPayroll()">
                            <mat-option *ngFor="let m of months" [value]="m">Tháng {{m}}</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="filter-field">
                        <mat-label>Năm</mat-label>
                        <mat-select [(ngModel)]="selectedYear" (selectionChange)="loadMonthlyPayroll()">
                            <mat-option *ngFor="let y of years" [value]="y">{{y}}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="action-group">
                    <button mat-flat-button color="primary" class="btn-calc" (click)="onCalculate()">
                        <mat-icon>calculate</mat-icon> Tính lương
                    </button>
                    <button mat-stroked-button class="btn-export" (click)="onExport()">
                        <mat-icon>file_download</mat-icon> Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table mat-table [dataSource]="dataSource" class="payroll-table">
                
                <ng-container matColumnDef="employeeName">
                    <th mat-header-cell *matHeaderCellDef> Nhân viên </th>
                    <td mat-cell *matCellDef="let row"> 
                        <span class="emp-name">{{row.employeeName}}</span> 
                    </td>
                </ng-container>

                <ng-container matColumnDef="monthYear">
                    <th mat-header-cell *matHeaderCellDef> Thời gian </th>
                    <td mat-cell *matCellDef="let row" class="text-muted"> 
                        Tháng {{row.month}}/{{row.year}} 
                    </td>
                </ng-container>

                <ng-container matColumnDef="basicSalary">
                    <th mat-header-cell *matHeaderCellDef> Lương cơ bản </th>
                    <td mat-cell *matCellDef="let row"> 
                        <span class="basic-salary">{{row.basicSalary | number}}</span>
                    </td>
                </ng-container>

                <ng-container matColumnDef="workDays">
                    <th mat-header-cell *matHeaderCellDef> Công thực tế </th>
                    <td mat-cell *matCellDef="let row"> 
                        <span class="work-badge">{{row.totalWorkDays}} / 26</span>
                    </td>
                </ng-container>

                <ng-container matColumnDef="finalSalary">
                    <th mat-header-cell *matHeaderCellDef> THỰC NHẬN </th>
                    <td mat-cell *matCellDef="let row"> 
                        <span class="final-amount">{{row.finalSalary | number}} đ</span>
                    </td>
                </ng-container>

                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef> Trạng thái </th>
                    <td mat-cell *matCellDef="let row">
                        <span class="status-badge" [ngClass]="row.status.toLowerCase()">
                            <mat-icon class="status-icon">{{ row.status === 'Paid' ? 'check_circle' : 'schedule' }}</mat-icon>
                            {{ row.status === 'Paid' ? 'Đã thanh toán' : 'Chờ xử lý' }}
                        </span>
                    </td>
                </ng-container>

                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef class="text-center"> Thao tác </th>
                    <td mat-cell *matCellDef="let row" class="text-center">
                        <button *ngIf="row.status === 'Pending'" 
                                mat-stroked-button 
                                class="btn-confirm"
                                (click)="markPaid(row.id)">
                            Xác nhận trả
                        </button>
                        <span *ngIf="row.status === 'Paid'" class="paid-date">
                            {{row.paymentDate | date:'dd/MM'}}
                        </span>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                
                <tr class="mat-row" *matNoDataRow>
                    <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">
                        <mat-icon>payments</mat-icon>
                        <span>Chưa có dữ liệu lương cho tháng này.</span>
                    </td>
                </tr>
            </table>
        </div>
        <mat-paginator [pageSizeOptions]="[10, 20]" showFirstLastButtons></mat-paginator>
    </div>
</div>